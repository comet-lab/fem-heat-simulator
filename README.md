# HeatSimulation


This code base models the thermal response of tissue to laser irradiation using the finite element method (FEM).
Our model assumes that the tissue can be represented as a cuboid. Each surface on the cuboid can have one of 
three boundary conditions: a heat sink, a flux boundary, or a convection boundary. 
For modeling details, see the reference below [1]. 

The main FEM modeling is performed in C++ using the Eigen Library. The file 'main.cpp' provides an example of 
how to initialize and run an FEM_Simulation object, which is defined in 'FEM_Simulation.h'. 
Additionally, the simulation can be called and run from MATLAB using the MEX file executable that gets generated 

## Dependencies

The Eigen3 library must be installed.

## Building the project

To build the project run the following commands:

``mkdir build``\
``cd build``\
``cmake ..``\
``cmake --build .``

This will create three executables and a library that can be included in other projects. 

- main.exe: This code simply demonstrates the execution of the simulator and serves as an example
- FEM_Unit_Tests.exe: runs unit tests for FEM_Simulator methods. 
- MEX_Heat_Simulation.mex*64: A mex file callable from matlab to run the simulator. 

The library name is Heat_Simulation.

## Description of the simulation class

The simulation class is declared in FEM_Simulator.h and defined in FEM_Simulator.cpp. 
See 'main.cpp' for an example of how to initialize and run the simulator. 
The simulator will discretize the mesh into elements, create the global M, K, and F matrices, and 
perform the time integration. Note that the simulator uses a left handed coordinate system. The origin is located
at the center of the top surface of the cuboid. Assuming a planar (2D) view of the tissue with the origin at the top of the page,
the z-axis points down the page, the x-axis points to the right, and the y-axis points into the page. 


To construct a basic simulation object, you need the following information

- ``Temp``: the initial temperature at every node in the mesh [°C],
- ``tissueSize``: the tissue size along the x, y, and z axes [cm]
- ``TC``: the thermal conductivity of the tissue [W/cm °C]
- ``VHC``: the volumetric heat capacity of the tissue [J/cm^3 °C]
- ``MUA``: the absorption coefficient of the laser [cm^-1]
- ``HTC``: the heat transfer coefficient [W/cm^2 °C]
- ``Nn1d``: the number of nodes along one dimension of an element. For linear basis functions use 2. For quadratic basis functions use 3. Some functionality may not be available with quadratic basis functions.

To perform the spatial discretization, run the function ``FEM_Simulator::createKMF()`` and perform the time stepping using
the function ``FEM_Simulator::performTimeStepping()``.
If there are no changes to the tissue geometry, number of nodes, boundary conditions, or laser input, the matrices do not need to be rebuilt
between subsequent calls to ``FEM_Simulator::performTimeStepping()``.

By default the, simulator assumes all 6 faces of the cuboid are dirichlet boundaries (i.e. heat sinks). To change the boundary conditions 
use the function 'FEM_Simulator::setBoundaryConditions(BC)'. The possible options are

- 0: Heat Sink (the initial temperature set at the boundary will be held constant)
- 1: Flux Boundary (for a flux boundary, the ``flux`` attribute needs to be set)
- 2: Convection Boundary (for a Convection boundary, the ``ambientTemp`` attribute needs to be set)

To set the fluence rate of the laser, use the method ``FEM_Simulator::setFluenceRate()``. The fluence rate at each node
can be passed in directly. It can also be generated by the simulator if the laser pose, laser power, beam waist,
and laser wavelength are passed in instead. 
If the absorption coefficient is very high, the fluence rate may need a large number of elements along the z-direction to 
approximate it. In this case, it may be appropriate to use the ``layerHeight`` and ``elemsInLayer`` attributes. 
These attributes allow the user to create a mesh with elements of varying length in the z-axis. 

- ``layerHeight``: the tissue size [cm] that corresponds to the first mesh layer
- ``elemsInLayer``: the number of elements that will be used to to represent the first layer

The remaining elements in the mesh will be used to represent the remaining block of tissue. 

Other parameters that can be adjusted include the type of time integration. By default, we use a step size of 0.01 seconds
and perform the time integration for 1 second. Both of these settings can be adjusted with ``deltaT`` and ``tFinal``. 
By default we use the Crank-Nicolson which sets a term ``alpha`` equal to 0.5. 
If backward Euler is desired, change ``alpha`` to 0. For forwad Euler, change ``alpha`` to 1. 

Additionally there is a setting to multi-thread for eigen, ``useAllCPUs``, and to remove print statements, ``silentMode``. 


## MEX Usage
The mex file can be called in MATALB as long as it is on the MATLAB Path. 
Example usage can be found in the folder MexTesting/MexFileTest.m

``[TPredLayer,sensorTempsLayer] = MEX_Heat_Simulation(T0,fluenceRate,tissueSize',tFinal,
            deltaT,tissueProperties,BC,Flux,ambientTemp,sensorPositions,useAllCPUs,
            silentMode,layerInfo,Nn1d,createMatrices);``


# References
[1] N. E. Pacheco, K. Zhang, A. S. Reyes, C. J. Pacheco, L. Burstein,
and L. Fichera, “Towards a physics engine to simulate robotic laser
surgery: Finite element modeling of thermal laser-tissue interactions,”
International Symposium on Medical Robotics, 2025, [In Press] Available:
https://arxiv.org/abs/2411.14249.
